<!doctype html>
<html lang="zh">

<head>
	<meta charset="UTF-8" />
	<meta
		name="viewport"
		content="width=device-width, initial-scale=1.0"
	/>
	<title>电压分压计算器</title>
	<link
		rel="stylesheet"
		href="/iframe/css/resistive-divider.css"
	/>
	<link
		rel="stylesheet"
		href="/iframe/css/common.css"
	/>
</head>

<body>
	<div class="container">
		<div class="left-section">
			<div class="input-row">
				<div>
					<label for="Vin">输入电压:</label>
					<input
						type="number"
						id="Vin"
						value="10"
						step="0.1"
					/>
				</div>
				<div>
					<label for="Vout">目标电压:</label>
					<input
						type="number"
						id="Vout"
						value="5"
						step="0.1"
					/>
				</div>


				<div>
					<label for="minResistor">最小值 (Ω):</label>
					<input
						type="text"
						id="minResistor"
						value="1k"
					/>
				</div>
				<div>
					<label for="maxResistor">最大值 (Ω):</label>
					<input
						type="text"
						id="maxResistor"
						value="1M"
					/>
				</div>
				<div>
					<label for="offsetPercentage">允许误差 (%):</label>
					<input
						type="number"
						id="offsetPercentage"
						value="1"
						step="0.1"
					/>
				</div>
				<div>
					<label for="resistorSeries">电阻系列:</label>
					<select id="resistorSeries">
						<option value="E48">E48</option>
						<option
							value="E96"
							selected
						>E96</option>
						<option value="E192">E192</option>
					</select>


				</div>
				
			</div>

			<button id="calculateButton">计算电阻组合</button>
		</div>
		<div class="right-section">
			<div
				class="results"
				id="results"
			></div>
		</div>
	</div>

	<script>
		const E96 = [
			100, 102, 105, 107, 110, 113, 115, 118, 121, 124, 127, 130, 133,
			137, 140, 143, 147, 150, 154, 158, 162, 165, 169, 174, 178, 182,
			187, 191, 196, 200, 205, 210, 215, 221, 226, 232, 237, 243, 249,
			255, 261, 267, 274, 280, 287, 294, 301, 309, 316, 324, 332, 340,
			348, 357, 365, 374, 383, 392, 402, 412, 422, 432, 442, 453, 464,
			475, 487, 499, 511, 523, 536, 549, 562, 576, 590, 604, 619, 634,
			649, 665, 681, 698, 715, 732, 750, 768, 787, 806, 825, 845, 866,
			887, 909, 931, 953, 976,
		];

		// E48标准值
		const E48 = [
			100, 105, 110, 115, 121, 127, 133, 140, 147, 154, 162, 169,
			178, 187, 196, 205, 215, 226, 237, 249, 261, 274, 287, 301,
			316, 332, 348, 365, 383, 402, 422, 442, 464, 487, 511, 536,
			562, 590, 619, 649, 681, 715, 750, 787, 825, 866, 909, 953
		];
		// E192标准值
		const E192 = [
			100, 101, 102, 104, 105, 106, 107, 109, 110, 111, 113, 114, 115, 117, 118, 120,
			121, 123, 124, 126, 127, 129, 130, 132, 133, 135, 137, 138, 140, 142, 143, 145,
			147, 149, 150, 152, 154, 156, 158, 160, 162, 164, 165, 167, 169, 172, 174, 176,
			178, 180, 182, 184, 187, 189, 191, 193, 196, 198, 200, 203, 205, 208, 210, 213,
			215, 218, 221, 223, 226, 229, 232, 234, 237, 240, 243, 246, 249, 252, 255, 258,
			261, 264, 267, 271, 274, 277, 280, 284, 287, 291, 294, 298, 301, 305, 309, 312,
			316, 320, 324, 328, 332, 336, 340, 344, 348, 352, 357, 361, 365, 370, 374, 379,
			383, 388, 392, 397, 402, 407, 412, 417, 422, 427, 432, 437, 442, 448, 453, 459,
			464, 470, 475, 481, 487, 493, 499, 505, 511, 517, 523, 530, 536, 542, 549, 556,
			562, 569, 576, 583, 590, 597, 604, 612, 619, 627, 634, 642, 649, 657, 665, 673,
			681, 690, 698, 706, 715, 723, 732, 741, 750, 759, 768, 777, 787, 796, 806, 816,
			825, 835, 845, 856, 866, 876, 887, 898, 909, 920, 931, 942, 953, 965, 976, 988
		];
		// 扩展到6个数量级
		const E48_extended = E48.flatMap((value) => Array.from({ length: 6 }, (_, i) => value * Math.pow(10, i)));
		const E96_extended = E96.flatMap((value) => Array.from({ length: 6 }, (_, i) => value * Math.pow(10, i)));
		const E192_extended = E192.flatMap((value) => Array.from({ length: 6 }, (_, i) => value * Math.pow(10, i)));

		// 辅助函数：解析带单位的电阻值
		function parseResistorValue (value) {
			const regex = /^(\d*\.?\d+)(k|M)?$/i; // 匹配数字后跟 k 或 M（单位可不区分大小写）
			const match = value.trim().toLowerCase().match(regex);
			if (!match) return null; // 如果没有匹配到，返回 null

			let resistorValue = parseFloat(match[1]);
			const unit = match[2];

			if (unit === 'k') resistorValue *= 1000; // k代表千欧
			if (unit === 'm') resistorValue *= 1000000; // M代表兆欧

			return resistorValue;
		}
		function calculateVoltageDivider (R1, R2, Vin) {
			return (Vin * R2) / (R1 + R2);
		}

		function findResistorCombinations (Vin, Vout, offsetPercentage, minResistor, maxResistor) {
			const bound = (Vout * offsetPercentage) / 100;
			let combinations = [];
			// 获取精度选择
			const series = document.getElementById('resistorSeries')?.value || 'E96';
			let resistorArray = E96_extended;
			if (series === 'E48') resistorArray = E48_extended;
			if (series === 'E192') resistorArray = E192_extended;

			resistorArray.forEach((R1) => {
				if (R1 < minResistor || R1 > maxResistor) return;
				resistorArray.forEach((R2) => {
					if (R2 < minResistor || R2 > maxResistor) return;
					const VoutCalculated = calculateVoltageDivider(R1, R2, Vin);
					if (Math.abs(VoutCalculated - Vout) <= bound) {
						combinations.push({
							R1,
							R2,
							VoutCalculated: VoutCalculated.toFixed(2),
						});
					}
				});
			});
			return combinations;
		}

		function updateResults (combinations) {
			const resultsDiv = document.getElementById('results');
			resultsDiv.innerHTML = '';

			// 右下角悬浮显示总数
			const countBadge = document.createElement('div');
			countBadge.className = 'results-count-badge';
			countBadge.textContent = `共 ${combinations.length} 组结果`;
			resultsDiv.appendChild(countBadge);

			if (combinations.length === 0) {
				resultsDiv.innerHTML += '<p>未找到符合条件的电阻组合。</p>';
				return;
			}

			combinations.forEach((combo) => {
				const resultDiv = document.createElement('div');
				resultDiv.classList.add('result-item');
				resultDiv.classList.add('theme-result-item');

				const errorValue = (combo.VoutCalculated - document.getElementById('Vout').value);
				const errorPercent = (errorValue / document.getElementById('Vout').value * 100);

				resultDiv.innerHTML = `
						<div style="font-size:1.1em;">
							<span>R1:${formatResistorValue(combo.R1)}</span>
							<span>R2:${formatResistorValue(combo.R2)}</span>
						</div>
						<div style="margin-top:6px;">
							<em>输出电压: ${combo.VoutCalculated}V</em>
						</div>
						<div style="margin-top:2px;">
							<em>误差: ${errorValue.toFixed(2)}V ${Math.abs(errorPercent).toFixed(2)}%</em>
						</div>
					`;
				resultsDiv.appendChild(resultDiv);
			});
		}

		// 辅助函数：格式化电阻值
		function formatResistorValue (value) {
			if (value >= 1e6) {
				return (value / 1e6).toFixed(2) + ' MΩ'; // 兆欧
			} else if (value >= 1e3) {
				return (value / 1e3).toFixed(2) + ' kΩ'; // 千欧
			} else {
				return value.toFixed(2) + ' Ω'; // 欧姆
			}
		}

		// 初始化
		document.addEventListener('DOMContentLoaded', function () {
			document.getElementById('calculateButton').addEventListener('click', () => {
				const Vin = document.getElementById('Vin').value;
				const Vout = document.getElementById('Vout').value;
				const offsetPercentage = document.getElementById('offsetPercentage').value;

				const minResistorValue = parseResistorValue(document.getElementById('minResistor').value);
				const maxResistorValue = parseResistorValue(document.getElementById('maxResistor').value);

				if (minResistorValue && maxResistorValue) {
					const combinations = findResistorCombinations(Vin, Vout, offsetPercentage, minResistorValue, maxResistorValue);
					updateResults(combinations);
				} else {
					alert('请输入有效的电阻值（带单位 k 或 M）');
				}
			});
		});
	</script>
</body>

</html>
