<!doctype html>
<html lang="zh">

<head>
	<meta charset="UTF-8" />
	<meta
		name="viewport"
		content="width=device-width, initial-scale=1.0"
	/>
	<title>开关电源反馈分压电阻计算器</title>
	<link
		rel="stylesheet"
		href="/iframe/css/resistive-divider.css"
	/>
	<link
		rel="stylesheet"
		href="/iframe/css/common.css"
	/>
</head>

<body>
	<div class="container">
		<div class="left-section">
			<div class="input-row">
				<div>
					<label for="Vin">输入电压</label>
					<input
						type="number"
						id="Vin"
						value="10"
						step="0.1"
					/>
				</div>
				<div>
					<label for="Vout">反馈电压</label>
					<input
						type="number"
						id="Vout"
						value="0.6"
						step="0.1"
					/>
				</div>


				<div>
					<label for="maxSumResistor">最大电阻和(Ω)</label>
					<input
						type="text"
						id="maxSumResistor"
						value="10M"
					/>
				</div>
				<div>
					<label for="offsetPercentage">允许误差(%)</label>
					<input
						type="number"
						id="offsetPercentage"
						value="1"
						step="0.1"
					/>
				</div>
				<div>
					<label for="resistorSeries">电阻系列</label>
					<select id="resistorSeries">
						<option value="E6">E6 ±20%</option>
						<option value="E12">E12 ±10%</option>
						<option value="E24">E24 ±5%</option>
						<option value="E48">E48 ±2%</option>
						<option value="E96" selected>E96 ±1%</option>
						<option value="E192">E192 ±0.5%</option>
					</select>
				</div>
				<div>
					<div class="mix-high-precision-row">
						<label for="mixHighPrecision" class="mix-high-precision-label">混合高精度</label>
						<input type="checkbox" id="mixHighPrecision" class="mix-high-precision-checkbox" />
					</div>
				</div>
				
			</div>

			<button id="calculateButton">计算反馈电阻组合</button>
		</div>
		<div class="right-section">
			<div
				class="results"
				id="results"
			></div>
		</div>
	</div>

	<script>
		// 动态生成标准电阻值（不使用显式数组）
		function generateResistorSeries(E, decades = 6) {
			const values = [];
			for (let d = 0; d < decades; d++) {
				const base = Math.pow(10, d + 2); // 从100Ω开始
				for (let i = 0; i < E; i++) {
					const value = base * Math.pow(10, i / E);
					// 四舍五入到最接近的整数
					values.push(Math.round(value));
				}
			}
			return Array.from(new Set(values)).sort((a, b) => a - b);
		}
		const E6_extended = generateResistorSeries(6);
		const E12_extended = generateResistorSeries(12);
		const E24_extended = generateResistorSeries(24);
		const E48_extended = generateResistorSeries(48);
		const E96_extended = generateResistorSeries(96);
		const E192_extended = generateResistorSeries(192);

		// 辅助函数：解析带单位的电阻值
		function parseResistorValue (value) {
			const regex = /^(\d*\.?\d+)(k|M)?$/i; // 匹配数字后跟 k 或 M（单位可不区分大小写）
			const match = value.trim().toLowerCase().match(regex);
			if (!match) return null; // 如果没有匹配到，返回 null

			let resistorValue = parseFloat(match[1]);
			const unit = match[2];

			if (unit === 'k') resistorValue *= 1000; // k代表千欧
			if (unit === 'm') resistorValue *= 1000000; // M代表兆欧

			return resistorValue;
		}
		function calculateVoltageDivider (R1, R2, Vin) {
			return (Vin * R2) / (R1 + R2);
		}

		function findResistorCombinations (Vin, Vout, offsetPercentage, maxSumResistor) {
			const bound = (Vout * offsetPercentage) / 100;
			let combinations = [];
			// 获取精度选择
			const series = document.getElementById('resistorSeries')?.value || 'E96';
			const mixHighPrecision = document.getElementById('mixHighPrecision').checked;
			// 系列精度从低到高排列
			const allSeries = [
				{ key: 'E6', arr: E6_extended },
				{ key: 'E12', arr: E12_extended },
				{ key: 'E24', arr: E24_extended },
				{ key: 'E48', arr: E48_extended },
				{ key: 'E96', arr: E96_extended },
				{ key: 'E192', arr: E192_extended }
			];
			let resistorArray;
			if (!mixHighPrecision) {
				resistorArray = allSeries.find(s => s.key === series)?.arr || E96_extended;
			} else {
				// 合并当前系列及更高精度系列
				let startIdx = allSeries.findIndex(s => s.key === series);
				resistorArray = Array.from(new Set(
					allSeries.slice(startIdx).flatMap(s => s.arr)
				)).sort((a, b) => a - b);
			}

			let checkedCount = 0;
			let matchedCount = 0;

			resistorArray.forEach((R1) => {
				resistorArray.forEach((R2) => {
					if (R1 + R2 > maxSumResistor) return;
					checkedCount++;
					const VoutCalculated = calculateVoltageDivider(R1, R2, Vin);
					if (Math.abs(VoutCalculated - Vout) <= bound) {
						matchedCount++;
						combinations.push({
							R1,
							R2,
							VoutCalculated: VoutCalculated.toFixed(2),
						});
					}
				});
			});
			return combinations;
		}

		function updateResults (combinations) {
			const resultsDiv = document.getElementById('results');
			resultsDiv.innerHTML = '';

			// 右下角悬浮显示总数
			const countBadge = document.createElement('div');
			countBadge.className = 'results-count-badge';
			countBadge.textContent = `共 ${combinations.length} 组结果`;
			resultsDiv.appendChild(countBadge);

			if (combinations.length === 0) {
				resultsDiv.innerHTML += '<p>未找到符合条件的电阻组合。</p>';
				return;
			}

			const targetVout = parseFloat(document.getElementById('Vout').value);
			// 排序：输入电压误差从小到大，误差一样按R1升序，R1一样按R2升序
			combinations.sort((a, b) => {
				const VinInput = parseFloat(document.getElementById('Vin').value);
				const VinA = (a.R1 + a.R2) * targetVout / a.R2;
				const VinB = (b.R1 + b.R2) * targetVout / b.R2;
				const errA = Math.abs(VinA - VinInput);
				const errB = Math.abs(VinB - VinInput);
				if (errA !== errB) return errA - errB;
				if (a.R1 !== b.R1) return a.R1 - b.R1;
				return a.R2 - b.R2;
			});

			combinations.forEach((combo) => {
				const resultDiv = document.createElement('div');
				resultDiv.classList.add('result-item');
				resultDiv.classList.add('theme-result-item');

				const VinCalculated = (combo.R1 + combo.R2) * targetVout / combo.R2;
				const VinInput = parseFloat(document.getElementById('Vin').value);
				const vinErrorValue = VinCalculated - VinInput;
				const vinErrorPercent = (vinErrorValue / VinInput) * 100;

				resultDiv.innerHTML = `
						<div style="font-size:1.1em;">
							<span>R1:${formatResistorValue(combo.R1)}</span><br/>
							<span>R2:${formatResistorValue(combo.R2)}</span>
						</div>
						<div style="margin-top:6px;">
							<span>输入电压: ${VinCalculated.toFixed(2)}V</span>
						</div>
						<div style="margin-top:2px;">
							<span>误差: ${vinErrorValue.toFixed(2)}V ${Math.abs(vinErrorPercent).toFixed(2)}%</span>
						</div>
					`;
				resultsDiv.appendChild(resultDiv);
			});
		}

		// 辅助函数：格式化电阻值
		function formatResistorValue (value) {
			if (value >= 1e6) {
				return (value / 1e6).toFixed(2) + ' MΩ'; // 兆欧
			} else if (value >= 1e3) {
				return (value / 1e3).toFixed(2) + ' kΩ'; // 千欧
			} else {
				return value.toFixed(2) + ' Ω'; // 欧姆
			}
		}

		// 初始化
		document.addEventListener('DOMContentLoaded', function () {
			document.getElementById('calculateButton').addEventListener('click', () => {
				const Vin = document.getElementById('Vin').value;
				const Vout = document.getElementById('Vout').value;
				const offsetPercentage = document.getElementById('offsetPercentage').value;
				const maxSumResistorValue = parseResistorValue(document.getElementById('maxSumResistor').value);
				if (maxSumResistorValue) {
					const combinations = findResistorCombinations(Vin, Vout, offsetPercentage, maxSumResistorValue);
					updateResults(combinations);
				} else {
					alert('请输入有效的电阻和最大值（带单位 k 或 M）');
				}
			});
		});
	</script>
</body>

</html>
